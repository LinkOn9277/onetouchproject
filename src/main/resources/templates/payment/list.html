<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}"
>
<head>
    <title>델리나잇</title>



    <!--별도 css 필요할 시 아래로 추가-->
    <!--어디서 그대로 가져오는거 아니면 클래스 이름 잘 붙여주고
    styles.css에 작성할것-->
</head>

<body>
<!--이 줄 div layout:fragment명과 id명 절대 수정 금지!!!!-->
<div layout:fragment="adminContent" id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-5">
            <!--내용 넣는 곳-->
            <!--반드시 이 아래에서만 작업-->

            <!--페이지 이름-->
            <h1 id="test" class="mt-5">정산 시스템</h1>
<form id="paymentForm">

    <div class="row">
        <!-- 날짜 필터 -->
        <div class="col-6">
            <label for="startDate">시작 날짜:</label>
            <input type="date" id="startDate" name="startDate">
        </div>
        <div class="col-6">
            <label for="endDate">종료 날짜:</label>
            <input type="date" id="endDate" name="endDate">
        </div>
    </div>

    <div class="row">
        <!-- 결제 방식 필터 -->
        <div class="col-6">
            <label for="orderType">결제 방식:</label>
            <select id="orderType" name="orderType">
                <option value="">전체</option>
                <option value="선결제">선결제</option>
                <option value="후결제">후결제</option>
            </select>
        </div>

        <!-- 정산 여부 필터 -->
        <div class="col-6">
            <label for="paidCheck">정산 여부:</label>
            <select id="paidCheck" name="paidCheck">
                <option value="">전체</option>
                <option value="Y">정산 완료</option>
                <option value="N">미정산</option>
            </select>
        </div>
    </div>

    <!-- 정산 타입 선택 (center, branch, hotel, store) -->
    <div class="row">
        <div class="col-6">
            <label for="type">정산 타입:</label>
            <select id="type" name="type">
                <option value="CENTER">본사</option>
                <option value="BRANCH">지점</option>
                <option value="HOTEL">호텔</option>
                <option value="STORE" selected>가맹점</option>
            </select>
        </div>
    </div>

    <!-- 조회 버튼 -->
    <button type="submit" class="btn btn-primary">조회</button>
</form>

<hr>

<!-- 결제 내역 테이블 -->
<table id="paymentResults">
    <thead>
    <tr>
        <th>결제 ID</th>
        <th>결제 금액</th>
        <th>결제 일시</th>
        <th>결제 방식</th>
        <th>매장명</th>
        <th>호텔명</th>
        <th>지점명</th>
        <th>센터명</th>
        <th>객실 번호</th>
        <th>정산 여부</th>
    </tr>
    </thead>
    <tbody>
    <!-- AJAX로 받아온 데이터가 여기에 채워짐 -->
    </tbody>
</table>
        </div>


        <script>

            // 공통 함수 : 결제 정산 목록 조회
            function loadPayment(data) {

                $.ajax({

                    url: '/api/payment/allDate',
                    type: 'get',
                    data: data,
                    success: function (response) {
                        console.log("정산 데이터 조회 완료", response);

                        $('#paymentResults tbody').empty();

                        if (response.length === 0) {
                            $('#paymentResults tbody').append('<tr><td colspan="10">정산 데이터가 없습니다.</td></tr>');
                            return
                        }

                        response.forEach(function (payment) {
                            let paidCheckText = payment.paidCheck ? '정산 완료' : '미정산';
                            let orderTypeText = payment.orderType === 'paid' ? '선결제' : '후결제';
                            let roomNumberText = payment.roomNumber ? payment.roomNumber : '-';
                            let payDateText = payment.payDateTime ? payment.payDateTime.replace('T', ' ') : '-';

                            let str = `<tr>
                             <td>${payment.id}</td>
                             <td>${Number(payment.amount).toLocaleString()}원</td>
                             <td>${payDateText}</td>
                             <td>${orderTypeText}</td>
                             <td>${payment.storeName}</td>
                             <td>${payment.hotelName}</td>
                             <td>${payment.branchName}</td>
                             <td>${payment.centerName}</td>
                             <td>${roomNumberText}</td>
                             <td>${paidCheckText}</td>
                           </tr>`;
                            $('#paymentResults tbody').append(str);
                        });
                    },
                    error: function (xhr, status, error) {
                        if (xhr.status === 400){
                            console.log("잘못된 요청(400 Error)입니다.");
                        } else if(xhr.status === 404){
                            console.log("정산 데이터(404 Error)가 없습니다.");
                        } else if (xhr.status === 500){
                            console.log("서버 오류가 발생(500 Error)했습니다.");
                        } else {
                            console.log("기타 오류 발생", xhr.responseText);
                        }
                    }

                })

            }

            // 조회 버튼 클릭 시 필터 기반 조회
            $('#paymentForm').on('submit', function (e) {
                e.preventDefault()
                let queryData = {
                    totalId: 1,
                    type: $('#type').val(),
                    startDate: $('#startDate').val(),
                    endDate: $('#endDate').val(),
                    orderType: $('#orderType').val(),
                    paidCheck: $('#paidCheck').val()
                }
                loadPayment(queryData)
            })

        </script>

    </main>
</div>
</body>
</html>
